var appModule=angular.module("AppModule",["ngRoute","checklist-model"]);appModule.constant("apiRootUrl","/api/"),appModule.config(["$routeProvider",function(e){e.when("/",{controller:"HomeCtrl",templateUrl:"partials/home.html"}),e.when("/apps",{controller:"AppsCtrl",templateUrl:"partials/apps.html"}),e.when("/apps/:appId",{controller:"AppCtrl",templateUrl:"partials/app.html"}),e.when("/apps/:appId/forms/create",{controller:"AppFormCreateCtrl",templateUrl:"partials/appFormCreate.html"}),e.when("/apps/:appId/forms/update/:formId",{controller:"AppFormCreateCtrl",templateUrl:"partials/appFormCreate.html"}),e.when("/apps/:appId/listings/create",{controller:"AppListingCreateCtrl",templateUrl:"partials/appListingCreate.html"}),e.when("/apps/:appId/listings/update/:listingId",{controller:"AppListingCreateCtrl",templateUrl:"partials/appListingCreate.html"}),e.when("/apps/:appId/navLinks/modify",{controller:"AppNavLinksModifyCtrl",templateUrl:"partials/appNavLinksModify.html"}),e.when("/apps/:appId/preview",{controller:"AppPreviewCtrl",templateUrl:"partials/appPreview.html"}),e.when("/apps/:appId/users/create",{controller:"AppUserCreateCtrl",templateUrl:"partials/appUserCreate.html"}),e.when("/apps/:appId/users",{controller:"AppUsersCtrl",templateUrl:"partials/appUsers.html"}),e.when("/apps/:appId/registration",{controller:"AppRegistrationCtrl",templateUrl:"partials/appRegistration.html"})}]),appModule.run(["$rootScope","$location","$http","apiRootUrl",function(e,t,n,i){e.waitMessages=[],n.get(i+"deploymentSite").success(function(t){e.deploymentSite=t.deploymentSite}),e.addWaitMessage=function(t,n){e.waitMessages.push({key:t,text:n})},e.removeWaitMessage=function(t){e.waitMessages=e.waitMessages.filter(function(e){return e.key!==t})},e.$on("$routeChangeStart",function(){e.authenticated||t.path("")}),e.logout=function(){e.authenticated=null,e.skipSessionCheck=!0,e.loggingOut=!0,n.get(i+"logout").success(function(){}).error(function(){}).finally(function(){e.loggingOut=!1})}}]),appModule.controller("AppCtrl",["$scope","$routeParams","DataService",function(e,t,n){e.appId=t.appId;var i="AppCtrl.getAppById";e.$root.addWaitMessage(i,"Getting app data"),e.initializing=!0,n.getAppById(Number(e.appId)).then(function(t){e.app=t}).finally(function(){e.$root.removeWaitMessage(i),e.initializing=!1}),e.navLinksTree=function(){var t=e.app.navLinks.links.filter(function(e){return!e.parentId});return t.forEach(function(t){t.children=e.app.navLinks.links.filter(function(e){return e.parentId===t.id})}),t}}]),appModule.controller("AppFormCreateCtrl",["$scope","$routeParams","$location","$q","DataService",function(e,t,n,i,r){e.appId=Number(t.appId);var a="AppFormCreateCtrl.getAppById";e.$root.addWaitMessage(a,"Getting app data"),e.initializing=!0;var o=[];if(e.formId=Number(t.formId)){var s=i.defer();o.push(s.promise);var p="AppFormCreateCtrl.getForm";e.$root.addWaitMessage(p,"Getting form data"),r.getForm(e.appId,e.formId).then(function(t){e.form=t,e.selectedField=e.form.fields[0]}).finally(function(){e.$root.removeWaitMessage(p),s.resolve()})}else e.form={fields:[]},e.selectedField=e.form.fields[0];var l=i.defer();o.push(l.promise),r.getAppById(e.appId).then(function(t){e.app=t}).finally(function(){l.resolve(),e.$root.removeWaitMessage(a)}),i.all(o).then(function(){e.initializing=!1}),e.types=["text","number","date","boolean","options"],e.optionTypes=["radio","checkbox","select","multi-select"],e.$watch("selectedField.optionType",function(t){"radio"===t&&(e.selectedField.required=!0)}),e.validateForm=function(){function t(t){for(var n=!0,i=0;i<t.length;i++){for(var r=0;r<t.length;r++)if(i!=r&&t[i].title===t[r].title){e.duplicateTitle=t[i].title,n=!1;break}if(!n)break}return n&&(e.duplicateTitle=null),n}return e.form&&e.form.title&&e.form.fields.length&&t(e.form.fields)&&e.form.fields.filter(function(e){return!!e.title&&!!e.type&&!!("options"!==e.type||e.optionType&&e.options)}).length===e.form.fields.length},e.save=function(t){e.saving=!0,r.saveForm(e.appId,t).then(function(){n.path("/apps/"+e.appId)}).finally(function(){e.saving=!1})},e.addField=function(){var t={title:"New Field"};e.form.fields.push(t),t.order=e.form.fields.length,e.selectedField=t},e.removeField=function(t){e.form.fields.splice(e.form.fields.indexOf(t),1),e.form.fields.filter(function(e){return e.order>t.order}).forEach(function(e){e.order--})},e.split=function(e){return e?e.split("\n"):""},e.moveFieldUp=function(t){if(1!==t.order){var n=e.form.fields.filter(function(e){return e.order===t.order-1})[0];n.order++,t.order--}},e.moveFieldDown=function(t){if(t.order!==e.form.fields.length){var n=e.form.fields.filter(function(e){return e.order===t.order+1})[0];n.order--,t.order++}},e.orderedFormFields=function(){return e.form?e.form.fields.sort(function(e,t){return e.order>t.order}):[]}}]),appModule.controller("AppListingCreateCtrl",["$scope","$routeParams","$location","$q","DataService",function(e,t,n,i,r){e.appId=Number(t.appId);var a="AppListingCreateCtrl.getAppById";e.$root.addWaitMessage(a,"Getting app data"),e.initializing=!0;var o=[];if(e.listingId=Number(t.listingId)){var s=i.defer();o.push(s.promise);var p="AppFormCreateCtrl.getListing";e.$root.addWaitMessage(p,"Getting listing data"),r.getListing(e.appId,e.listingId).then(function(t){e.originalListing=t,e.listing=t}).finally(function(){e.$root.removeWaitMessage(p),s.resolve()})}else e.listing={fields:[]};var l=i.defer();o.push(l.promise),r.getAppById(e.appId).then(function(t){e.app=t}).finally(function(){l.resolve(),e.$root.removeWaitMessage(a)}),i.all(o).then(function(){e.initializing=!1}),e.formSelected=function(){if(e.listing)if(e.originalListing&&e.listing.formId===e.originalListing.formId)e.listing.fields=e.originalListing.fields;else{var t={};e.selectedForm().fields.forEach(function(e){t[e.id]=!1}),e.listing.fields=t}},e.noSelectedFields=function(){if(!e.listing)return!1;for(var t in e.listing.fields)if(e.listing.fields[t])return!1;return!0},e.listingFields=function(){if(!e.listing)return[];var t=[];for(var n in e.listing.fields)e.listing.fields[n]&&t.push(Number(n));return e.selectedForm().fields.filter(function(e){return t.indexOf(e.id)>-1})},e.orderedListingFields=function(){if(!e.listing)return[];var t=e.listingFields();return t.forEach(function(t){t.order=e.orderedSelectedFields().filter(function(e){return e.id===t.id})[0].order}),t.sort(function(e,t){return e.order>t.order})},e.selectedForm=function(){return e.app.forms.filter(function(t){return t.id===e.listing.formId})[0]},e.selectedFields=function(){if(!e.listing)return[];var t=[];for(var n in e.listing.fields)e.listing.fields[n]&&t.push(Number(n));return t},e.fieldTitle=function(t){return e.selectedForm().fields.filter(function(e){return e.id===t})[0].title},e.sampleValue=function(e){switch(e.type){case"text":return"Sample Value";case"number":return 42;case"date":return(new Date).toDateString();case"boolean":return"Yes";case"options":return["radio","select"].indexOf(e.optionType)>-1?e.options.split("\n")[0]:e.options.split("\n").join(", ");default:return"Unknown type: "+e.type}},e.save=function(t){e.saving=!0,r.saveListing(e.appId,t).then(function(){n.path("/apps/"+e.appId)}).finally(function(){e.saving=!1})},e.moveFieldUp=function(t){if(1!==t.order){var n=e.listing.order.filter(function(e){return e.order===t.order-1})[0];n.order++,t.order--}},e.moveFieldDown=function(t){if(t.order!==e.listing.order.length){var n=e.listing.order.filter(function(e){return e.order===t.order+1})[0];n.order--,t.order++}},e.orderedSelectedFields=function(){if(!e.listing)return[];var t=e.selectedFields();if(!e.listing.order||!e.listing.order.length||e.listing.order.length!==t.length){var n=1;e.listing.order=t.map(function(e){return{id:e,order:n++}})}var i=e.listing.order.sort(function(e,t){return e.order>t.order});return e.selectedField&&-1!==i.indexOf(e.selectedField)||(e.selectedField=i[0]),i}}]),appModule.controller("AppNavLinksModifyCtrl",["$scope","$routeParams","$location","DataService",function(e,t,n,i){e.appId=t.appId,e.navLink={};var r="AppFormCreateCtrl.getAppById";e.$root.addWaitMessage(r,"Getting app data"),e.initializing=!0,i.getAppById(Number(e.appId)).then(function(t){function n(e,t){return e.map(function(e){return{title:e.title,id:e.id,type:t}})}e.app=t,e.linkTargets=n(t.forms,"Forms").concat(n(t.listings,"Listings"))}).finally(function(){e.$root.removeWaitMessage(r),e.initializing=!1}),e.dropdownNavLinks=function(){return e.app.navLinks.links.filter(function(e){return"dropdown"===e.type})},e.navLinksTree=function(){if(!e.app)return[];var t=e.app.navLinks.links.filter(function(e){return!e.parentId});return t.forEach(function(t){t.children=e.app.navLinks.links.filter(function(e){return e.parentId===t.id})}),t},e.editNavLink=function(t){e.navLink=angular.copy(t)},e.removeParent=function(){e.navLink.parentId=null},e.saveNavLink=function(){e.savingNavLink=!0;var t=e.navLink;i.saveNavLink(e.app.id,t).then(function(n){if(t.id){var i=e.app.navLinks.links.filter(function(e){return e.id===t.id})[0],r=e.app.navLinks.links.indexOf(i);e.app.navLinks.links[r]=t}else t.id=n,e.app.navLinks.links.push(t);e.navLink={}}).finally(function(){e.savingNavLink=!1})},e.saveShowLinks=function(){e.savingShowLinks=!0,i.saveShowLinks(e.appId,e.app.navLinks.showLinks).finally(function(){e.savingShowLinks=!1})}}]),appModule.controller("AppPreviewCtrl",["$scope","$routeParams","$location","DataService",function(e,t,n,i){e.appId=Number(t.appId);var r="AppFormCreateCtrl.getAppById";e.$root.addWaitMessage(r,"Getting app data"),e.initializing=!0,e.data={},i.getAppById(Number(e.appId)).then(function(t){function n(e,t){return e.map(function(e){return{name:e.name,id:e.id,type:t}})}e.app=t,e.linkTargets=n(t.forms,"Forms").concat(n(t.listings,"Listings"))}).finally(function(){e.$root.removeWaitMessage(r),e.initializing=!1}),e.navLinksTree=function(){if(!e.app)return[];var t=e.app.navLinks.links.filter(function(e){return!e.parentId});return t.forEach(function(t){t.children=e.app.navLinks.links.filter(function(e){return e.parentId===t.id})}),t},e.show=function(t){e.selectedNavLink=t;var n=e.app[t.linkTarget.type.toLowerCase()];if(e.obj=n.filter(function(e){return e.id===t.linkTarget.id})[0],"Forms"===t.linkTarget.type&&t.linkTarget.update){var r=e.data[t.linkTarget.id][0];e.obj.fields.forEach(function(e){e.value=r[e.title]})}if("Listings"===t.linkTarget.type){var a=[];for(var o in e.obj.fields)e.obj.fields[o]&&a.push(o);i.getForm(e.appId,e.obj.formId).then(function(t){e.listingFields=t.fields.filter(function(e){return a.indexOf(e.title)>-1})})}},e.saveForm=function(t){var n={};t.fields.forEach(function(e){n[e.title]=e.value}),e.data[t.id]=e.data[t.id]||[],e.data[t.id].push(n),t.fields.forEach(function(e){e.value=null})},e.split=function(e){return e?e.split("\n"):""}}]),appModule.controller("AppRegistrationCtrl",["$scope","$routeParams","$location","DataService",function(e,t,n,i){e.appId=Number(t.appId);var r="AppRegistrationCtrl.getAppById";e.$root.addWaitMessage(r,"Getting app data"),e.initializing=!0,i.getAppById(e.appId).then(function(t){e.app=t,e.registration=t.registration}).finally(function(){e.$root.removeWaitMessage(r),e.initializing=!1}),e.save=function(t){e.saving=!0,i.saveRegistration(e.appId,t).then(function(){n.path("/apps/"+e.appId)}).finally(function(){e.saving=!1})}}]),appModule.controller("AppUserCreateCtrl",["$scope","$routeParams","$location","DataService",function(e,t,n,i){function r(t,n){e.validationErrors=[],t.password!==t.confirmPassword&&e.validationErrors.push("Password and confirm password fields must match."),n(0===e.validationErrors.length)}e.appId=Number(t.appId);var a="AppUsersCtrl.getAppById";e.$root.addWaitMessage(a,"Getting app data"),e.initializing=!0,i.getAppById(e.appId).then(function(t){e.app=t}).finally(function(){e.$root.removeWaitMessage(a),e.initializing=!1}),e.user={},e.create=function(t){r(t,function(r){r&&(e.saving=!0,i.createUser(e.appId,t).then(function(){n.path("/apps/"+e.appId)}).finally(function(){e.saving=!1}))})}}]),appModule.controller("AppUsersCtrl",["$scope","$routeParams","$location","$q","DataService",function(e,t,n,i,r){e.appId=Number(t.appId);var a="AppUsersCtrl.getAppById";e.$root.addWaitMessage(a,"Getting app data"),e.initializing=!0;var o=[],s=i.defer();o.push(s.promise),r.getAppById(e.appId).then(function(t){e.app=t}).finally(function(){s.resolve(),e.$root.removeWaitMessage(a)});var p="AppUsersCtrl.getUsersByAppId";e.$root.addWaitMessage(p,"Getting users");var l=i.defer();o.push(l.promise),r.getUsersByAppId(e.appId).then(function(t){e.users=t}).finally(function(){l.resolve(),e.$root.removeWaitMessage(p)}),i.all(o).then(function(){e.initializing=!1})}]),appModule.controller("AppsCtrl",["$scope","$location","DataService",function(e,t,n){e.$root.title="Apps",e.newApp={};var i="AppCtrl.getAppById";e.$root.addWaitMessage(i,"Getting apps"),e.initializing=!0,n.getApps().then(function(t){e.apps=t}).finally(function(){e.$root.removeWaitMessage(i),e.initializing=!1}),e.create=function(){e.saving=!0,n.createApp(e.newApp).then(function(n){t.path("/apps/"+n),e.saving=!1})}}]),appModule.factory("DataService",["$q","$http","apiRootUrl",function(e,t,n){function i(t){var n=e.defer();return t(n),n.promise}return{authenticate:function(e){return i(function(i){t.post(n+"login",e).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)})})},whoami:function(){return i(function(e){t.get(n+"whoami").success(function(t){e.resolve(t.username)}).error(function(t){e.reject(t)})})},getApps:function(){return i(function(e){t.get(n+"apps").success(function(t){e.resolve(t)})})},getAppById:function(e){return i(function(i){t.get(n+"apps",{params:{id:e}}).success(function(e){i.resolve(e)})})},createApp:function(e){return i(function(i){t.post(n+"apps",e).success(function(e){i.resolve(e.id)})})},saveForm:function(e,r){return i(function(i){t.post(n+"forms",r,{params:{appId:e}}).success(function(){i.resolve()})})},saveListing:function(e,r){return i(function(i){t.post(n+"listings",r,{params:{appId:e}}).success(function(){i.resolve()})})},getForm:function(e,r){return i(function(i){t.get(n+"forms",{params:{appId:e,formId:r}}).success(function(e){i.resolve(e)})})},getListing:function(e,r){return i(function(i){t.get(n+"listings",{params:{appId:e,listingId:r}}).success(function(e){i.resolve(e)})})},getNavLinks:function(e){return i(function(i){t.get(n+"navLinks",{params:{appId:e}}).success(function(e){i.resolve(e)})})},saveNavLink:function(e,r){return i(function(i){t.post(n+"navLinks",r,{params:{appId:e}}).success(function(e){i.resolve(e.id)})})},createUser:function(e,r){return i(function(i){t.post(n+"users",r,{params:{appId:e}}).success(function(){i.resolve()})})},saveRegistration:function(e,r){return i(function(i){t.post(n+"registration",r,{params:{appId:e}}).success(function(){i.resolve()})})},saveShowLinks:function(e,r){return i(function(i){t.post(n+"navLinksShowLinks",r,{params:{appId:e}}).success(function(){i.resolve()})})},getUsersByAppId:function(e){return i(function(i){t.get(n+"users",{params:{appId:e}}).success(function(e){i.resolve(e)})})}}}]),appModule.controller("HomeCtrl",["$scope","$location","DataService",function(e,t,n){if(e.$root.title=null,e.loginForm={},!e.$root.skipSessionCheck){var i="HomeCtrl.initialwhoami";e.$root.addWaitMessage(i,"Checking for previous session"),e.initializing=!0,n.whoami().then(function(n){n&&(e.$root.authenticated=!0,e.$root.authenticated&&t.path("/apps"))}).catch(function(t){e.$root.err=t}).finally(function(){e.$root.removeWaitMessage(i),e.initializing=!1})}e.login=function(){e.invalidLogin=!1,e.authenticating=!0;var i=e.loginForm;n.authenticate(i).then(function(n){n.validLogin?(e.$root.authenticated=!0,t.path("/apps")):(e.invalidLogin=!0,e.loginForm.password=null)}).catch(function(t){e.$root.err=t}).finally(function(){e.authenticating=!1})}}]);